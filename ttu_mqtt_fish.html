<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MQTT Web Controller with Video Stream</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.1.0/paho-mqtt.min.js"></script>
    
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            <!DOCTYPE html>
            <html lang="zh-Hant">
            <head>
                <meta charset="UTF-8">
                <meta name="viewport" content="width=device-width, initial-scale=1.0">
                <title>MQTT Web Controller with Video Stream</title>
                <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.1.0/paho-mqtt.min.js"></script>
                <style>
                    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial; background:#f0f2f5; margin:0; padding:20px; color:#333 }
                    .card { background:#fff; padding:20px; border-radius:10px; box-shadow:0 6px 18px rgba(0,0,0,0.08); max-width:900px; margin:20px auto }
                    h1{margin:0 0 10px 0}
                    label{display:block;margin:6px 0 2px;font-size:0.9em}
                    input, select {width:100%; padding:8px; box-sizing:border-box; margin-bottom:8px}
                    .row {display:flex; gap:12px}
                    .col {flex:1}
                    .controls{display:grid; grid-template-columns:1fr 1fr; gap:12px}
                    button{padding:10px 14px;border-radius:8px;border:0;color:#fff;background:#1976d2;cursor:pointer}
                    button.secondary{background:#00796b}
                    button.warn{background:#c62828}
                    .status{font-weight:bold}
                    .small{font-size:0.9em;color:#666}
                    #notification{position:fixed;top:16px;left:50%;transform:translateX(-50%);background:#333;color:#fff;padding:10px 16px;border-radius:6px;opacity:0;transition:opacity .3s}
                </style>
            </head>
            <body>
                <div class="card">
                    <h1>大同資工 魚菜共生 - MQTT 控制</h1>
                    <p class="small">在下方設定 broker/port/ws_path (例如 test.mosquitto.org / 8081 / /mqtt)。可把設定儲存到 ESP（需與 ESP 同一網路）。</p>
                    <div class="row">
                        <div class="col">
                            <label for="broker">Broker (host)</label>
                            <input id="broker" placeholder="test.mosquitto.org" />
                        </div>
                        <div class="col">
                            <label for="port">Port</label>
                            <input id="port" placeholder="8081" />
                        </div>
                        <div class="col">
                            <label for="ws_path">WS Path</label>
                            <input id="ws_path" placeholder="/mqtt" />
                        </div>
                    </div>
                    <div class="row">
                        <div class="col">
                            <label for="client_id">Client ID</label>
                            <input id="client_id" placeholder="TtuFishWeb_123" />
                        </div>
                        <div class="col">
                            <label for="device_ip">ESP Device IP (optional)</label>
                            <input id="device_ip" placeholder="192.168.4.1" />
                        </div>
                    </div>
                    <div style="display:flex; gap:8px; margin-top:8px;">
                        <button id="connect-btn">連線</button>
                        <button id="save-local" class="secondary">儲存本機</button>
                        <button id="save-device" class="secondary">儲存到裝置</button>
                        <button id="clear-local" class="warn">清空本機設定</button>
                    </div>
                    <div style="margin-top:12px">
                        MQTT 狀態: <span id="status-label" class="status">尚未連線</span>
                    </div>
                </div>

                <div class="card">
                    <h2>繼電器 (relay)</h2>
                    <div style="display:flex; gap:8px; align-items:center">
                        <button id="relay-on">ON</button>
                        <button id="relay-off" class="secondary">OFF</button>
                        <button id="relay-toggle" class="secondary">TOGGLE</button>
                        <div style="margin-left:16px">狀態: <span id="relay-status">未知</span></div>
                    </div>
                </div>

                <div class="card">
                    <h2>總控馬達</h2>
                    <div class="controls">
                        <button id="btn-fwd-1" class="secondary" data-motor="1" data-action="forward">1號正轉</button>
                        <button id="btn-rev-1" class="secondary" data-motor="1" data-action="reverse">1號反轉</button>
                        <button id="btn-fwd-2" class="secondary" data-motor="2" data-action="forward">2號正轉</button>
                        <button id="btn-rev-2" class="secondary" data-motor="2" data-action="reverse">2號反轉</button>
                    </div>
                </div>

                <div id="notification"></div>

                <script>
                (function(){
                    // 元件
                    const brokerEl = document.getElementById('broker');
                    const portEl = document.getElementById('port');
                    const wsPathEl = document.getElementById('ws_path');
                    const clientIdEl = document.getElementById('client_id');
                    const deviceIpEl = document.getElementById('device_ip');
                    const connectBtn = document.getElementById('connect-btn');
                    const saveLocalBtn = document.getElementById('save-local');
                    const saveDeviceBtn = document.getElementById('save-device');
                    const clearLocalBtn = document.getElementById('clear-local');
                    const statusLabel = document.getElementById('status-label');
                    const notification = document.getElementById('notification');

                    // relay
                    const relayOnBtn = document.getElementById('relay-on');
                    const relayOffBtn = document.getElementById('relay-off');
                    const relayToggleBtn = document.getElementById('relay-toggle');
                    const relayStatusLabel = document.getElementById('relay-status');

                    // motors
                    const motorButtons = document.querySelectorAll('[data-motor]');

                    // defaults
                    const DEFAULTS = { broker:'test.mosquitto.org', port:8081, ws_path:'/mqtt', clientId:'TtuFishWeb_'+Math.floor(Math.random()*1000) };

                    // topics
                    const TOPIC_RELAY_CMD = 'ttu/relay';
                    const TOPIC_RELAY_STATUS = 'ttu/relay/status';
                    const TOPIC_MOTOR1 = 'ttu_fish/motor1';
                    const TOPIC_MOTOR2 = 'ttu_fish/motor2';

                    // runtime
                    let client = null;
                    let isConnected = false;

                    // helpers
                    function showNotification(msg,d=2500){ notification.textContent=msg; notification.style.opacity=1; setTimeout(()=>notification.style.opacity=0,d);} 
                    function loadLocal(){
                        const s = localStorage.getItem('ttu_mqtt_cfg');
                        if(s){ try{ const o=JSON.parse(s); brokerEl.value=o.broker||DEFAULTS.broker; portEl.value=o.port||DEFAULTS.port; wsPathEl.value=o.ws_path||DEFAULTS.ws_path; clientIdEl.value=o.clientId||DEFAULTS.clientId; deviceIpEl.value=o.deviceIp||''; }catch(e){} }
                        else { brokerEl.value=DEFAULTS.broker; portEl.value=DEFAULTS.port; wsPathEl.value=DEFAULTS.ws_path; clientIdEl.value=DEFAULTS.clientId; }
                    }
                    function saveLocal(){ const o={broker:brokerEl.value, port:portEl.value, ws_path:wsPathEl.value, clientId:clientIdEl.value, deviceIp:deviceIpEl.value}; localStorage.setItem('ttu_mqtt_cfg', JSON.stringify(o)); showNotification('已儲存到本機'); }
                    function clearLocal(){ localStorage.removeItem('ttu_mqtt_cfg'); loadLocal(); showNotification('已清除本機設定'); }

                    // build Paho client with ws path
                    function createClient(){
                        const host = brokerEl.value;
                        const port = Number(portEl.value);
                        const path = wsPathEl.value || '/mqtt';
                        const clientId = clientIdEl.value || DEFAULTS.clientId;
                        // Paho.Client(host, port, path, clientId)
                        try{
                            client = new Paho.Client(host, port, path, clientId);
                        }catch(e){ showNotification('建立 MQTT client 失敗: '+e); console.error(e); }
                        if(!client) return;
                        client.onConnectionLost = onConnectionLost;
                        client.onMessageArrived = onMessageArrived;
                    }

                    function onConnect(){ isConnected=true; statusLabel.textContent='已連線'; showNotification('MQTT 已連線',1500); try{ client.subscribe(TOPIC_RELAY_STATUS); client.subscribe(TOPIC_MOTOR1); client.subscribe(TOPIC_MOTOR2);}catch(e){} }
                    function onConnectionLost(resp){ isConnected=false; statusLabel.textContent='尚未連線'; showNotification('MQTT 連線已斷開',1500); }
                    function onFailure(resp){ isConnected=false; statusLabel.textContent='連線失敗'; showNotification('連線失敗'); console.error(resp); }
                    function onMessageArrived(msg){ try{ console.log('msg',msg.destinationName,msg.payloadString); if(msg.destinationName===TOPIC_RELAY_STATUS){ relayStatusLabel.textContent=msg.payloadString; } }catch(e){ console.error(e);} }

                    function connect(){ if(isConnected) return; createClient(); if(!client){showNotification('無法建立 client'); return;} statusLabel.textContent='連線中...'; try{ client.connect({onSuccess:onConnect, onFailure:onFailure, useSSL:true}); }catch(e){ onFailure(e);} }
                    function disconnect(){ if(!client) return; try{ client.disconnect(); }catch(e){} isConnected=false; statusLabel.textContent='尚未連線'; }
                    function publish(topic,payload){ if(!isConnected){ showNotification('尚未連線'); return;} const m=new Paho.Message(payload); m.destinationName=topic; client.send(m); }

                    // relay events
                    relayOnBtn.addEventListener('click', ()=>{ publish(TOPIC_RELAY_CMD,'ON'); });
                    relayOffBtn.addEventListener('click', ()=>{ publish(TOPIC_RELAY_CMD,'OFF'); });
                    relayToggleBtn.addEventListener('click', ()=>{ publish(TOPIC_RELAY_CMD,'TOGGLE'); });

                    // motor events
                    motorButtons.forEach(b=>b.addEventListener('click', ()=>{ const motor=b.dataset.motor; const action=b.dataset.action; const payload = (action==='forward')? '1':'2'; const topic = motor==='1'? TOPIC_MOTOR1:TOPIC_MOTOR2; publish(topic,payload); }));

                    // UI buttons
                    connectBtn.addEventListener('click', ()=>{ if(isConnected) disconnect(); else connect(); });
                    saveLocalBtn.addEventListener('click', saveLocal); clearLocalBtn.addEventListener('click', clearLocal);

                    // save to device -> POST /config on device IP
                    saveDeviceBtn.addEventListener('click', async ()=>{
                        const ip = deviceIpEl.value.trim(); if(!ip){ showNotification('請填寫 ESP IP'); return; }
                        const url = `http://${ip}/config`;
                        const body = new URLSearchParams(); body.append('server', brokerEl.value); body.append('port', portEl.value); body.append('user',''); body.append('password',''); body.append('topic_cmd', TOPIC_RELAY_CMD); body.append('topic_status', TOPIC_RELAY_STATUS); body.append('use_tls', '1'); body.append('ws_path', wsPathEl.value || '/mqtt');
                        try{
                            const resp = await fetch(url, { method:'POST', body: body });
                            const text = await resp.text();
                            showNotification('已儲存到裝置');
                        }catch(e){ showNotification('儲存到裝置失敗: '+e,4000); console.error(e); }
                    });

                    // 初始化
                    loadLocal();
                })();
                </script>
            </body>
            </html>
                                const motor = btn.dataset.motor;
                                const action = btn.dataset.action;
                                btn.textContent = `${motor}號${action === 'forward'? '正轉' : '反轉'}`;
                                btn.classList.remove('stop');
                            }
                        });

                        // relay buttons
                        if (relayOnBtn) relayOnBtn.disabled = !isConnected;
                        if (relayOffBtn) relayOffBtn.disabled = !isConnected;
                        if (relayToggleBtn) relayToggleBtn.disabled = !isConnected;
                    }
            
                    let notificationTimer;
                    function showNotification(message) {
                        notification.textContent = message;
                        notification.classList.add('show');
                        clearTimeout(notificationTimer);
                        notificationTimer = setTimeout(() => {
                            notification.classList.remove('show');
                        }, 3000);
                    }

                    // --- 事件監聽器 ---
                    connectBtn.addEventListener('click', () => {
                        if (isConnected) {
                            disconnect();
                        } else {
                            connect();
                        }
                    });

                    motorButtons.forEach(btn => {
                        btn.addEventListener('click', () => {
                            handleMotorControl(btn.dataset.motor, btn.dataset.action);
                        });
                    });

                    if (relayOnBtn) relayOnBtn.addEventListener('click', () => handleRelayCommand('ON'));
                    if (relayOffBtn) relayOffBtn.addEventListener('click', () => handleRelayCommand('OFF'));
                    if (relayToggleBtn) relayToggleBtn.addEventListener('click', () => handleRelayCommand('TOGGLE'));

                    // --- 初始呼叫 ---
                    updateUI();
                });
            </script>
                motorStates = { '1': 0, '2': 0 }; // 重置狀態
                updateUI();
            }

            function onMessageArrived(message) {
                console.log(`收到訊息: Topic=${message.destinationName}, Payload=${message.payloadString}`);
                // 此處可擴展用於處理從設備接收的狀態回饋
            }

            function onFailure(responseObject) {
                console.error("連線失敗: " + responseObject.errorMessage);
                isConnected = false;
                showNotification("連線失敗，請檢查 Broker 設定或網路。");
                updateUI();
            }

            // --- 核心功能函式 ---

            function connect() {
                if (isConnected) return;

                console.log(`正在連線至 wss://${MQTT_BROKER}:${MQTT_PORT}`);
                statusLabel.textContent = '連線中...';
                statusLabel.className = 'status-connecting';
                
                client = new Paho.Client(MQTT_BROKER, MQTT_PORT, MQTT_CLIENT_ID);
                
                client.onConnectionLost = onConnectionLost;
                client.onMessageArrived = onMessageArrived;
                
                client.connect({
                    onSuccess: onConnect,
                    onFailure: onFailure,
                    useSSL: true
                });
            }

            function disconnect() {
                if (!isConnected) return;
                console.log("正在斷開連線...");
                client.disconnect();
                isConnected = false; // 立即更新狀態
                updateUI();
            }

            function publishMessage(topic, payload) {
                if (!isConnected) {
                    showNotification("沒有成功連線MQTT");
                    return;
                }
                const message = new Paho.Message(payload);
                message.destinationName = topic;
                client.send(message);
                console.log(`已發布訊息: Topic=${topic}, Payload=${payload}`);
            }

            function handleMotorControl(motor, action) {
                if (!isConnected) {
                    showNotification("沒有成功連線MQTT");
                    return;
                }

                const topic = (motor === '1')? TOPIC_MOTOR1 : TOPIC_MOTOR2;
                let payload = '0'; // 預設為停止
                
                const currentState = motorStates[motor];
                const actionValue = (action === 'forward')? 1 : 2;

                if (currentState === actionValue) {
                    motorStates[motor] = 0;
                    payload = '0';
                } else {
                    motorStates[motor] = actionValue;
                    payload = (action === 'forward')? '1' : '2';
                }
                
                publishMessage(topic, payload);
                updateUI();
            }

            // --- UI 更新與輔助函式 ---

            function updateUI() {
                if (isConnected) {
                    statusLabel.textContent = '已連線';
                    statusLabel.className = 'status-connected';
                    connectBtn.textContent = '斷開連線';
                    connectBtn.classList.add('connected');
                } else {
                    if (statusLabel.className !== 'status-connecting') {
                        statusLabel.textContent = '尚未連線';
                        statusLabel.className = 'status-disconnected';
                    }
                    connectBtn.textContent = '連線';
                    connectBtn.classList.remove('connected');
                }

                motorButtons.forEach(btn => {
                    btn.disabled = !isConnected;
                    if (isConnected) {
                        const motor = btn.dataset.motor;
                        const action = btn.dataset.action;
                        const currentState = motorStates[motor];
                        const actionValue = (action === 'forward')? 1 : 2;

                        if (currentState === actionValue) {
                            btn.textContent = `${motor}號停止`;
                            btn.classList.add('stop');
                        } else {
                            btn.textContent = `${motor}號${action === 'forward'? '正轉' : '反轉'}`;
                            btn.classList.remove('stop');
                        }
                    } else {
                        const motor = btn.dataset.motor;
                        const action = btn.dataset.action;
                        btn.textContent = `${motor}號${action === 'forward'? '正轉' : '反轉'}`;
                        btn.classList.remove('stop');
                    }
                });
            }
            
            let notificationTimer;
            function showNotification(message) {
                notification.textContent = message;
                notification.classList.add('show');
                clearTimeout(notificationTimer);
                notificationTimer = setTimeout(() => {
                    notification.classList.remove('show');
                }, 3000);
            }

            // --- 事件監聽器 ---
            connectBtn.addEventListener('click', () => {
                if (isConnected) {
                    disconnect();
                } else {
                    connect();
                }
            });

            motorButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    handleMotorControl(btn.dataset.motor, btn.dataset.action);
                });
            });

            // --- 初始呼叫 ---
            updateUI();
        });
    </script>

</body>
</html>
