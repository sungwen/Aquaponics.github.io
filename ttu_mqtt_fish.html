<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MQTT Relay Controller (對齊 ESP 設定)</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.1.0/paho-mqtt.min.js"></script>
  <style>
    :root { --bg:#f0f2f5; --card:#fff; --text:#333; --primary:#1976d2; --danger:#c62828; --ok:#2e7d32; --muted:#607d8b; }
    body { margin:0; padding:20px; background:var(--bg); color:var(--text); font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial;}
    .wrap { max-width:980px; margin:0 auto; display:grid; grid-template-columns: 1fr 1fr; gap:20px; }
    .card { background:var(--card); border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,.08); padding:20px; }
    h1 { font-size:1.4rem; margin:0 0 12px; color:#1a237e; }
    h2 { font-size:1.05rem; margin:0 0 12px; color:#455a64; }
    .row { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    label { font-size:.9rem; color:#455a64; display:block; margin:8px 0 6px; }
    input[type="text"],input[type="number"],input[type="password"]{
      width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; font-size:.95rem;
    }
    .inline { display:flex; align-items:center; gap:10px; }
    .hint { font-size:.85rem; color:var(--muted); }
    .status { font-weight:700; }
    .status.ok { color:var(--ok); }
    .status.bad { color:var(--danger); }
    button {
      border:none; border-radius:10px; padding:12px 16px; font-weight:700; color:#fff; cursor:pointer;
      background:var(--primary); transition:.2s transform,.2s filter;
    }
    button:active { transform:scale(.98); }
    button.secondary { background:#455a64; }
    button.danger { background:var(--danger); }
    button:disabled { filter:grayscale(.6); cursor:not-allowed; }
    .dot { display:inline-block; width:10px; height:10px; border-radius:50%; margin-right:8px; background:#9e9e9e; vertical-align:middle; }
    .dot.on { background:var(--ok); }
    .dot.off { background:var(--danger); }
    code { background:#eef3f7; padding:2px 6px; border-radius:6px; }
    .footer { grid-column: 1/-1; text-align:center; color:var(--muted); font-size:.9rem; }
    @media (max-width:900px){ .wrap { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <div class="wrap">
    <!-- 連線設定（對齊 ESP 的 mqttCfg 結構） -->
    <div class="card">
      <h1>連線設定（對齊 ESP `mqttCfg`）</h1>
      <div class="row">
        <div>
          <label>Broker 主機（如：test.mosquitto.org 或 192.168.1.10）</label>
          <input id="broker" type="text" placeholder="e.g. test.mosquitto.org"/>
        </div>
        <div>
          <label>WebSocket 連接埠（WS/WSS）</label>
          <input id="port" type="number" placeholder="e.g. 8080 / 8081"/>
        </div>
      </div>
      <div class="row">
        <div>
          <label>使用者（MQTT User，可留空）</label>
          <input id="user" type="text" placeholder="可留空"/>
        </div>
        <div>
          <label>密碼（MQTT Pass，可留空）</label>
          <input id="pass" type="password" placeholder="可留空"/>
        </div>
      </div>
      <div class="row">
        <div>
          <label>Command Topic（發佈 ON/OFF/TOGGLE）</label>
          <input id="topicCmd" type="text" placeholder="e.g. ttu_fish/relay/cmd"/>
        </div>
        <div>
          <label>Status Topic（訂閱，ESP 端 retain=TRUE）</label>
          <input id="topicStatus" type="text" placeholder="e.g. ttu_fish/relay/status"/>
        </div>
      </div>
      <div class="row">
        <div class="inline">
          <input id="useSSL" type="checkbox"/>
          <label for="useSSL">使用 TLS（WSS）</label>
        </div>
        <div>
          <label>WebSocket Path（多數為 /mqtt）</label>
          <input id="wsPath" type="text" placeholder="/mqtt"/>
        </div>
      </div>
      <div class="inline" style="margin-top:12px; gap:10px;">
        <button id="save">儲存設定</button>
        <button id="reset" class="secondary">清空設定</button>
      </div>
      <p class="hint" style="margin-top:10px;">
        提示：此頁只會對 <code>Command Topic</code> 發佈指令（不使用 retained），
        狀態以 <code>Status Topic</code> 由裝置回報（retained=TRUE）。<br/>
        這正對齊你的 ESP 端 <code>publishStatus()</code> 與 <code>mqttCallback()</code> 設計。
      </p>
    </div>

    <!-- 連線＆狀態 -->
    <div class="card">
      <h1>MQTT 連線</h1>
      <div style="margin:8px 0;">
        狀態：<span id="connStatus" class="status bad">尚未連線</span>
      </div>
      <div class="inline" style="gap:10px; margin-bottom:10px;">
        <button id="btnConnect">連線</button>
        <button id="btnDisconnect" class="danger" disabled>斷線</button>
      </div>
      <div class="hint" id="info"></div>
      <hr style="margin:18px 0; border:none; border-top:1px solid #eee;"/>
      <h2>Relay 狀態</h2>
      <div style="font-size:1.1rem; margin:6px 0 12px;">
        <span id="relayDot" class="dot"></span>
        <span id="relayText">未知（等待狀態）</span>
      </div>
      <div class="inline" style="gap:10px;">
        <button id="btnOn"  class="secondary" disabled>ON</button>
        <button id="btnOff" class="secondary" disabled>OFF</button>
        <button id="btnToggle" disabled>TOGGLE</button>
      </div>
      <p class="hint" style="margin-top:10px;">
        訂閱：<code id="showTopicStatus"></code><br/>
        發佈：<code id="showTopicCmd"></code>
      </p>
    </div>

    <!-- （可選）你的影像框 -->
    <div class="card" style="grid-column:1/-1;">
      <h2>即時影像畫面</h2>
      <iframe
        style="width:100%; height:460px; border:1px solid #ddd; border-radius:12px; background:#000;"
        src="https://www.homeyes.com.tw/site1/fish.php?uid=SSAE-029609-FDEBC&box=0&r=rtsp%3A%2F%2Fwww.homeyes.com.tw%3A7554%2F22"
        title="Live Video Stream" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen>
      </iframe>
    </div>

    <div class="footer">前端設定已對齊 ESP8266 端設計：Command Topic 發指令；Status Topic 讀取 retained 狀態。</div>
  </div>

  <script>
    // =============================
    // 儲存/讀取設定（localStorage）
    // =============================
    const els = {
      broker: document.getElementById('broker'),
      port: document.getElementById('port'),
      user: document.getElementById('user'),
      pass: document.getElementById('pass'),
      topicCmd: document.getElementById('topicCmd'),
      topicStatus: document.getElementById('topicStatus'),
      useSSL: document.getElementById('useSSL'),
      wsPath: document.getElementById('wsPath'),
      save: document.getElementById('save'),
      reset: document.getElementById('reset'),
      btnConnect: document.getElementById('btnConnect'),
      btnDisconnect: document.getElementById('btnDisconnect'),
      connStatus: document.getElementById('connStatus'),
      info: document.getElementById('info'),
      showTopicStatus: document.getElementById('showTopicStatus'),
      showTopicCmd: document.getElementById('showTopicCmd'),
      relayDot: document.getElementById('relayDot'),
      relayText: document.getElementById('relayText'),
      btnOn: document.getElementById('btnOn'),
      btnOff: document.getElementById('btnOff'),
      btnToggle: document.getElementById('btnToggle'),
    };

    const LS_KEY = 'mqtt-relay-ui';

    function loadSettings() {
      const s = JSON.parse(localStorage.getItem(LS_KEY) || '{}');
      els.broker.value = s.broker ?? 'test.mosquitto.org';
      els.port.value = s.port ?? 8081;
      els.user.value = s.user ?? '';
      els.pass.value = s.pass ?? '';
      els.topicCmd.value = s.topicCmd ?? 'ttu_fish/relay/cmd';
      els.topicStatus.value = s.topicStatus ?? 'ttu_fish/relay/status';
      els.useSSL.checked = s.useSSL ?? true;
      els.wsPath.value = s.wsPath ?? '/mqtt';
      reflectTopicHints();
    }
    function saveSettings() {
      const s = {
        broker: els.broker.value.trim(),
        port: parseInt(els.port.value,10) || 0,
        user: els.user.value,
        pass: els.pass.value,
        topicCmd: els.topicCmd.value.trim(),
        topicStatus: els.topicStatus.value.trim(),
        useSSL: !!els.useSSL.checked,
        wsPath: els.wsPath.value.trim() || '/mqtt',
      };
      localStorage.setItem(LS_KEY, JSON.stringify(s));
      reflectTopicHints();
      flashInfo('設定已儲存');
    }
    function resetSettings() {
      localStorage.removeItem(LS_KEY);
      loadSettings();
      flashInfo('設定已清空並套用預設值');
    }
    function reflectTopicHints() {
      els.showTopicCmd.textContent = els.topicCmd.value.trim();
      els.showTopicStatus.textContent = els.topicStatus.value.trim();
    }

    els.save.addEventListener('click', saveSettings);
    els.reset.addEventListener('click', resetSettings);
    loadSettings();

    // =============================
    // MQTT 連線 & Relay 控制
    // =============================
    let client = null;
    let isConnected = false;
    let relayState = null; // true=ON, false=OFF, null=未知

    function setConnUI(connected) {
      isConnected = connected;
      els.btnConnect.disabled = connected;
      els.btnDisconnect.disabled = !connected;
      els.btnOn.disabled = !connected;
      els.btnOff.disabled = !connected;
      els.btnToggle.disabled = !connected;
      els.connStatus.textContent = connected ? '已連線' : '尚未連線';
      els.connStatus.className = 'status ' + (connected ? 'ok':'bad');
    }
    function setRelayUI(state) {
      relayState = state;
      els.relayDot.classList.remove('on','off');
      if (state === true) { els.relayDot.classList.add('on'); els.relayText.textContent='ON'; }
      else if (state === false) { els.relayDot.classList.add('off'); els.relayText.textContent='OFF'; }
      else { els.relayText.textContent='未知（等待狀態）'; }
    }
    function flashInfo(msg) {
      els.info.textContent = msg;
      setTimeout(()=>{ els.info.textContent=''; }, 2500);
    }

    function connectMQTT() {
      const s = JSON.parse(localStorage.getItem(LS_KEY) || '{}');
      const host = s.broker, port = s.port, useSSL = !!s.useSSL;
      const path = (s.wsPath || '/mqtt').trim();
      if (!host || !port) { flashInfo('請先完成連線設定'); return; }

      const clientId = 'web_relay_' + Math.floor(Math.random()*999999);
      // Paho: new Paho.Client(host, port, path, clientId)
      client = new Paho.Client(host, Number(port), path, clientId);

      client.onConnectionLost = (res) => {
        setConnUI(false);
        setRelayUI(null);
        if (res.errorCode !== 0) flashInfo('連線丟失：' + res.errorMessage);
      };
      client.onMessageArrived = (message) => {
        // 只關注 Status Topic
        const sTopic = (s.topicStatus || '').trim();
        if (message.destinationName === sTopic) {
          const p = (message.payloadString || '').trim().toUpperCase();
          if (p === 'ON' || p === '1') setRelayUI(true);
          else if (p === 'OFF' || p === '0') setRelayUI(false);
        }
      };

      const opts = {
        timeout: 8,
        useSSL,
        onSuccess: () => {
          setConnUI(true);
          // 訂閱狀態（retained）
          const sTopic = (s.topicStatus || '').trim();
          if (sTopic) client.subscribe(sTopic, { qos:0 });
          flashInfo(`已連線（${useSSL?'WSS':'WS'}://${host}:${port}${path}）`);
        },
        onFailure: (err) => {
          setConnUI(false);
          flashInfo('連線失敗：' + (err.errorMessage || 'unknown'));
        }
      };
      // 若有帳密
      if (s.user) opts.userName = s.user;
      if (s.pass) opts.password = s.pass;

      client.connect(opts);
    }

    function disconnectMQTT() {
      try { client && client.disconnect(); } catch(e){}
      setConnUI(false);
      setRelayUI(null);
    }

    function publishCmd(payload) {
      if (!isConnected || !client) { flashInfo('尚未連線'); return; }
      const s = JSON.parse(localStorage.getItem(LS_KEY) || '{}');
      const cTopic = (s.topicCmd || '').trim();
      if (!cTopic) { flashInfo('未設定 Command Topic'); return; }
      const msg = new Paho.Message(payload);
      msg.destinationName = cTopic;
      // 重要：命令不保留，避免重連時重複觸發
      msg.retained = false;
      msg.qos = 0;
      client.send(msg);
      // 樂觀更新（最終仍以裝置回報為準）
      if (payload === 'ON' || payload === '1') setRelayUI(true);
      else if (payload === 'OFF' || payload === '0') setRelayUI(false);
      flashInfo(`已發佈：${cTopic} → ${payload}`);
    }

    els.btnConnect.addEventListener('click', connectMQTT);
    els.btnDisconnect.addEventListener('click', disconnectMQTT);
    els.btnOn.addEventListener('click', ()=> publishCmd('ON'));
    els.btnOff.addEventListener('click', ()=> publishCmd('OFF'));
    els.btnToggle.addEventListener('click', ()=> publishCmd('TOGGLE'));

    // 初始狀態
    setConnUI(false);
    setRelayUI(null);
  </script>
</body>
</html>
