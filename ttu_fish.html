<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>繼電器控制介面（三段狀態連線按鈕）</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.1.0/paho-mqtt.min.js"></script>
  <style>
    body {
      font-family: "Segoe UI", Arial, sans-serif;
      background: #f4f6f8;
      margin: 0;
      padding: 20px;
    }
    .relay-card {
      background: #fff;
      padding: 24px;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      max-width: 480px;
      margin: auto;
    }
    h2 { color: #1a237e; text-align: center; }
    .inline { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; justify-content: center; margin-top: 15px; }
    button {
      border: none;
      border-radius: 8px;
      color: white;
      font-weight: bold;
      font-size: 1em;
      padding: 10px 18px;
      cursor: pointer;
      transition: background-color 0.3s, transform 0.1s;
    }
    button:active { transform: scale(0.97); }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    .btn-on { background: #2e7d32; }       /* 綠色: 可連線 */
    .btn-wait { background: #f57c00; }     /* 橘色: 連線中 */
    .btn-danger { background: #c62828; }   /* 紅色: 已連線 */
    .btn-off { background: #b71c1c; }
    .btn-toggle { background: #455a64; }
    .dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 8px; background: #9e9e9e; vertical-align: middle; }
    .dot.on { background: #2e7d32; }
    .dot.off { background: #b71c1c; }
    .status-connected { color: #2e7d32; }
    .status-disconnected { color: #b71c1c; }
    .status-connecting { color: #f57c00; }
    .notification {
      position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
      background: #333; color: white; padding: 10px 20px; border-radius: 5px;
      opacity: 0; transition: opacity 0.4s; z-index: 999;
    }
    .notification.show { opacity: 1; }
  </style>
</head>
<body>

<div class="relay-card">
  <h2>繼電器 MQTT 控制</h2>
  <div class="inline">
    <span>連線狀態：</span>
    <span id="rel_conn" class="status-disconnected">尚未連線</span>
  </div>
  <div class="inline">
    <button id="rel_connect" class="btn-on">繼電器連線</button>
    <button id="rel_disconnect" class="btn-danger" disabled>繼電器斷線</button>
  </div>
  <div class="inline">
    <span id="rel_dot" class="dot"></span>
    <span id="rel_text">未知（等待狀態）</span>
  </div>
  <div class="inline">
    <button id="rel_on" class="btn-on" disabled>ON</button>
    <button id="rel_off" class="btn-off" disabled>OFF</button>
    <button id="rel_toggle" class="btn-toggle" disabled>TOGGLE</button>
  </div>
  <p style="text-align:center;margin-top:10px;color:#607d8b;">主題：<code id="rel_topic_show">ttu_fish/relay</code></p>
</div>

<div id="notification" class="notification"></div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const notification = document.getElementById('notification');
  const relEls = {
    conn: document.getElementById('rel_conn'),
    connect: document.getElementById('rel_connect'),
    disconnect: document.getElementById('rel_disconnect'),
    on: document.getElementById('rel_on'),
    off: document.getElementById('rel_off'),
    toggle: document.getElementById('rel_toggle'),
    dot: document.getElementById('rel_dot'),
    text: document.getElementById('rel_text'),
    topicShow: document.getElementById('rel_topic_show')
  };

  // MQTT 連線設定
  const BROKER = "test.mosquitto.org";
  const PORT = 8081;
  const TOPIC = "ttu_fish/relay";
  let relClient = null, relConnected = false, relState = null;

  function toast(msg) {
    notification.textContent = msg;
    notification.classList.add('show');
    clearTimeout(window._toastTimer);
    window._toastTimer = setTimeout(() => notification.classList.remove('show'), 2000);
  }

  function setRelayUI(status) {
    // 狀態: 'disconnected' | 'connecting' | 'connected'
    relEls.conn.className = `status-${status}`;
    relEls.conn.textContent =
      status === 'connected' ? '已連線' :
      status === 'connecting' ? '連線中...' : '尚未連線';

    if (status === 'disconnected') {
      relEls.connect.disabled = false;
      relEls.connect.className = 'btn-on';
      relEls.connect.textContent = '繼電器連線';
      relEls.disconnect.disabled = true;
    } else if (status === 'connecting') {
      relEls.connect.disabled = true;
      relEls.connect.className = 'btn-wait';
      relEls.connect.textContent = '連線中...';
      relEls.disconnect.disabled = true;
    } else if (status === 'connected') {
      relEls.connect.disabled = false;
      relEls.connect.className = 'btn-danger';
      relEls.connect.textContent = '已連線中';
      relEls.disconnect.disabled = false;
    }

    const enable = (status === 'connected');
    relEls.on.disabled = relEls.off.disabled = relEls.toggle.disabled = !enable;
  }

  function setRelayState(state) {
    relState = state;
    relEls.dot.classList.remove('on','off');
    if (state === true) {
      relEls.dot.classList.add('on');
      relEls.text.textContent = 'ON';
    } else if (state === false) {
      relEls.dot.classList.add('off');
      relEls.text.textContent = 'OFF';
    } else {
      relEls.text.textContent = '未知（等待狀態）';
    }
  }

  function connectRelay() {
    if (relConnected) return;
    setRelayUI('connecting');
    const cid = "relay_web_" + Math.floor(Math.random()*1e6);
    relClient = new Paho.Client(BROKER, Number(PORT), cid);
    relClient.onConnectionLost = res => {
      relConnected = false;
      setRelayUI('disconnected');
      setRelayState(null);
      if (res.errorCode !== 0) toast("連線丟失: " + res.errorMessage);
    };
    relClient.onMessageArrived = msg => {
      const p = msg.payloadString.trim().toUpperCase();
      if (p === 'ON' || p === '1') setRelayState(true);
      else if (p === 'OFF' || p === '0') setRelayState(false);
    };
    relClient.connect({
      useSSL: true,
      timeout: 8,
      onSuccess: () => {
        relConnected = true;
        setRelayUI('connected');
        relClient.subscribe(TOPIC);
        toast("繼電器已連線成功");
      },
      onFailure: err => {
        relConnected = false;
        setRelayUI('disconnected');
        toast("連線失敗: " + err.errorMessage);
      }
    });
  }

  function disconnectRelay() {
    if (!relClient) return;
    try { relClient.disconnect(); } catch(e){}
    relConnected = false;
    setRelayUI('disconnected');
    setRelayState(null);
    toast("已斷線");
  }

  function publishRelay(payload) {
    if (!relConnected) return toast("尚未連線");
    const msg = new Paho.Message(payload);
    msg.destinationName = TOPIC;
    msg.retained = false;
    relClient.send(msg);
    if (payload === 'ON') setRelayState(true);
    else if (payload === 'OFF') setRelayState(false);
    toast(`發佈: ${payload}`);
  }

  relEls.connect.addEventListener('click', connectRelay);
  relEls.disconnect.addEventListener('click', disconnectRelay);
  relEls.on.addEventListener('click', () => publishRelay('ON'));
  relEls.off.addEventListener('click', () => publishRelay('OFF'));
  relEls.toggle.addEventListener('click', () => publishRelay('TOGGLE'));

  // 初始狀態
  setRelayUI('disconnected');
  setRelayState(null);
});
</script>
</body>
</html>
